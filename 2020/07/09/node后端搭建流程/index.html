<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>express后端搭建流程 | 大白腿</title><meta name="description" content="初始化先建个如server的文件夹，之后npm init -y先初始化一下项目新建个index.js 之后去package.json里配置一下热更新&quot;serve&quot;: &quot;nodemon index.js&quot;,这样就可以像启动vue一样npm run serve来启动服务器了 如果没有nodemon需要先全局安装一下 写服务端接口的准备工作先把常用的插件先下来下如"><meta name="keywords" content="element,node,express"><meta name="author" content="大白腿"><meta name="copyright" content="大白腿"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="express后端搭建流程"><meta name="twitter:description" content="初始化先建个如server的文件夹，之后npm init -y先初始化一下项目新建个index.js 之后去package.json里配置一下热更新&quot;serve&quot;: &quot;nodemon index.js&quot;,这样就可以像启动vue一样npm run serve来启动服务器了 如果没有nodemon需要先全局安装一下 写服务端接口的准备工作先把常用的插件先下来下如"><meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="og:type" content="article"><meta property="og:title" content="express后端搭建流程"><meta property="og:url" content="http://yoursite.com/2020/07/09/node%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA%E6%B5%81%E7%A8%8B/"><meta property="og:site_name" content="大白腿"><meta property="og:description" content="初始化先建个如server的文件夹，之后npm init -y先初始化一下项目新建个index.js 之后去package.json里配置一下热更新&quot;serve&quot;: &quot;nodemon index.js&quot;,这样就可以像启动vue一样npm run serve来启动服务器了 如果没有nodemon需要先全局安装一下 写服务端接口的准备工作先把常用的插件先下来下如"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2020-07-09T09:57:00.000Z"><meta property="article:modified_time" content="2020-08-11T06:35:13.642Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/07/09/node%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA%E6%B5%81%E7%A8%8B/"><link rel="prev" title="vue数据改变页面不更新" href="http://yoursite.com/2020/07/20/vue%E6%95%B0%E6%8D%AE%E6%94%B9%E5%8F%98%E9%A1%B5%E9%9D%A2%E4%B8%8D%E6%9B%B4%E6%96%B0/"><link rel="next" title="vue2.x升级成vue3" href="http://yoursite.com/2020/07/09/vue2-x%E5%8D%87%E7%BA%A7%E6%88%90vue3/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/timg.gif" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">149</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">30</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">21</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化"><span class="toc-number">1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#写服务端接口的准备工作"><span class="toc-number">2.</span> <span class="toc-text">写服务端接口的准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开始连接mongo数据库"><span class="toc-number">3.</span> <span class="toc-text">开始连接mongo数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建模型"><span class="toc-number">4.</span> <span class="toc-text">创建模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在后台编辑分类"><span class="toc-number">5.</span> <span class="toc-text">在后台编辑分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除分类"><span class="toc-number">6.</span> <span class="toc-text">删除分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上级分类"><span class="toc-number">7.</span> <span class="toc-text">上级分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通用CRUD接口"><span class="toc-number">8.</span> <span class="toc-text">通用CRUD接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#图片上传"><span class="toc-number">9.</span> <span class="toc-text">图片上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#富文本"><span class="toc-number">10.</span> <span class="toc-text">富文本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登录权限问题"><span class="toc-number">11.</span> <span class="toc-text">登录权限问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端接口实例"><span class="toc-number">12.</span> <span class="toc-text">前端接口实例</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">大白腿</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">express后端搭建流程</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-07-09 17:57:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-07-09</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-08-11 14:35:13"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-08-11</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/node/">node</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>先建个如server的文件夹，之后<code>npm init -y</code>先初始化一下项目<br>新建个index.js</p>
<p>之后去package.json里配置一下热更新<code>&quot;serve&quot;: &quot;nodemon index.js&quot;,</code><br>这样就可以像启动vue一样<code>npm run serve</code>来启动服务器了</p>
<p><img src="/images/pasted-40.png" alt="upload successful"><br>如果没有nodemon需要先全局安装一下</p>
<h3 id="写服务端接口的准备工作"><a href="#写服务端接口的准备工作" class="headerlink" title="写服务端接口的准备工作"></a>写服务端接口的准备工作</h3><p>先把常用的插件先下来下如：npm i express@next mongoose cors 等</p>
<p>之后在index.js里</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>,()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"http://localhost:3000"</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>之后新建个如routes的文件夹开始写路由</p>
<p><img src="/images/pasted-41.png" alt="upload successful"></p>
<p>routes/admin/index</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>)</span><br><span class="line">    <span class="keyword">const</span> router = express.Router()<span class="comment">//用到了子路由</span></span><br><span class="line">    router.post(<span class="string">"/categories"</span>,<span class="keyword">async</span> (req,res)=&gt;&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;)</span><br><span class="line">    app.use(<span class="string">"/admin/api"</span>,router)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里接收个参数app需要在index.js里传过来<br><code>require(&quot;./routes/admin/index&quot;)(app)</code></p>
<p><img src="/images/pasted-42.png" alt="upload successful"></p>
<h3 id="开始连接mongo数据库"><a href="#开始连接mongo数据库" class="headerlink" title="开始连接mongo数据库"></a>开始连接mongo数据库</h3><p>建议新建个如plugins的文件夹,之后建个db.js的文件，用来连接数据库</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>)<span class="comment">//引用mongoose</span></span><br><span class="line">    <span class="comment">//连接数据库 127.0.0.1:27017 是默认地址   bsdz是数据库名</span></span><br><span class="line">    mongoose.connect(<span class="string">'mongodb://127.0.0.1:27017/bsdz'</span>,&#123;</span><br><span class="line">        useNewUrlParser : <span class="literal">true</span>,</span><br><span class="line">        useUnifiedTopology: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时服务端的文件结构是这样的</p>
<p><img src="/images/pasted-43.png" alt="upload successful"></p>
<p>之后在index.js里引用一下db.js，把app传进去（和routes一样）<br><code>require(&quot;./plugins/db&quot;)(app)</code></p>
<h3 id="创建模型"><a href="#创建模型" class="headerlink" title="创建模型"></a>创建模型</h3><p>新建个models的文件夹用来存放模型<br>新建个模型文件如：Category.js</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>)<span class="comment">//引入mongo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//每一个schema就是一个文件，整个模型是一个集合</span></span><br><span class="line"><span class="keyword">const</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    <span class="comment">//开始定义需要的字段 name是key ,type是类型</span></span><br><span class="line">    name:&#123;</span><br><span class="line">        type:<span class="built_in">String</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = mongoose.model(<span class="string">"Category"</span>,schema)</span><br></pre></td></tr></table></figure>
<p>去index.js里去使用</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>)</span><br><span class="line">    <span class="keyword">const</span> router = express.Router()<span class="comment">//用到了子路由</span></span><br><span class="line">    <span class="keyword">const</span> Category = <span class="built_in">require</span>(<span class="string">"../../models/Category"</span>)<span class="comment">//引入模型</span></span><br><span class="line">    router.post(<span class="string">"/categories"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">await</span> Category.create(req.body)<span class="comment">//将传进来的内容创建到集合中</span></span><br><span class="line">        res.send(model)<span class="comment">//发送到客户端</span></span><br><span class="line">    &#125;)</span><br><span class="line">    app.use(<span class="string">"/admin/api"</span>, router)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时需要去index.js里写个处理数据的中间件,顺便把cors跨域模块也引进来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app.use(require(&quot;cors&quot;)())&#x2F;&#x2F;跨域模块</span><br><span class="line">app.use(express.json())&#x2F;&#x2F;处理req.body</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-44.png" alt="upload successful"></p>
<p>前端写个axios试试好不好使</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> save() &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.axios.post(<span class="string">"categories"</span>, <span class="keyword">this</span>.model);</span><br><span class="line">  <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">    <span class="keyword">this</span>.$router.push(<span class="string">"/categories/list"</span>);</span><br><span class="line">    <span class="keyword">this</span>.$message(&#123;</span><br><span class="line">      type: <span class="string">"success"</span>,</span><br><span class="line">      message: <span class="string">"保存成功"</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果这里报错了，有可能是mongodb设置权限了，需要给用户添加权限</p>
<p>这样新建分类的接口就写好了，<br>之后同理写个分类列表的接口</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">router.get(<span class="string">"/categories"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> items = <span class="keyword">await</span> Category.find().limit(<span class="number">10</span>)<span class="comment">//查找所有数据，限制10条</span></span><br><span class="line">    res.send(items)<span class="comment">//发送到客户端</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


<h3 id="在后台编辑分类"><a href="#在后台编辑分类" class="headerlink" title="在后台编辑分类"></a>在后台编辑分类</h3><p>先定义一个点击事件，点击时跳转到分类的详情页</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-button</span> <span class="attr">type</span>=<span class="string">"primary"</span> <span class="attr">size</span>=<span class="string">"small"</span></span></span><br><span class="line"><span class="tag"> @<span class="attr">click</span>=<span class="string">"$router.push(`/categories/edit/$&#123;scope.row._id&#125;`)"</span>&gt;</span>编辑<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/pasted-45.png" alt="upload successful"></p>
<p>之后去路由里解耦</p>
<p><img src="/images/pasted-46.png" alt="upload successful"><br>这样详情页就可以直接props:[id]拿到传过来的id了</p>
<p>拿到id后就可以请求详情页的数据了</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">methods:&#123;</span><br><span class="line">    <span class="keyword">async</span> fetch()&#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.axios.get(<span class="string">`/categories/<span class="subst">$&#123;<span class="keyword">this</span>.id&#125;</span>`</span>)</span><br><span class="line">        <span class="keyword">this</span>.model = res.data</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">created()&#123;</span><br><span class="line">    <span class="comment">//有id才会执行fetch</span></span><br><span class="line">    <span class="keyword">this</span>.id &amp;&amp; <span class="keyword">this</span>.fetch()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 但是这时候后端详情的接口还没有，就需要去后端写详情接口了</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> <span class="comment">//详情接口</span></span><br><span class="line">router.get(<span class="string">"/categories/:id"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> model = <span class="keyword">await</span> Category.findById(req.params.id)<span class="comment">//通关id找</span></span><br><span class="line">    res.send(model)<span class="comment">//发送到客户端</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


<p> 后台保存时需要判断是新建还是编辑，走不同的接口<br> <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">async</span> save() &#123;</span><br><span class="line">  <span class="keyword">let</span> res;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.id) &#123;</span><br><span class="line">  	<span class="comment">//如果有id就是编辑走put</span></span><br><span class="line">    res = <span class="keyword">await</span> <span class="keyword">this</span>.axios.put(<span class="string">`categories/<span class="subst">$&#123;<span class="keyword">this</span>.id&#125;</span>`</span>, <span class="keyword">this</span>.model);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">//没有就算新建走post</span></span><br><span class="line">    res = <span class="keyword">await</span> <span class="keyword">this</span>.axios.post(<span class="string">"categories"</span>, <span class="keyword">this</span>.model);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (res.data) &#123;</span><br><span class="line">    <span class="keyword">this</span>.$router.push(<span class="string">"/categories/list"</span>);</span><br><span class="line">    <span class="keyword">this</span>.$message(&#123;</span><br><span class="line">      type: <span class="string">"success"</span>,</span><br><span class="line">      message: <span class="string">"保存成功"</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 之后去后端定义编辑的put接口<br> <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//编辑接口</span></span><br><span class="line">router.put(<span class="string">"/categories/:id"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> model = <span class="keyword">await</span> Category.findByIdAndUpdate(req.params.id,req.body)<span class="comment">//通过id找之后更新,两个参数第一个是要找的id，第二个就是要更新的数据</span></span><br><span class="line">    res.send(model)<span class="comment">//发送到客户端</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="删除分类"><a href="#删除分类" class="headerlink" title="删除分类"></a>删除分类</h3><p> 先定义一个删除事件<br> <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-button</span> <span class="attr">type</span>=<span class="string">"primary"</span> <span class="attr">size</span>=<span class="string">"small"</span></span></span><br><span class="line"><span class="tag"> @<span class="attr">click</span>=<span class="string">"remove(scope.row)"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br></pre></td></tr></table></figure><br>参数是这整个一行的数据scope.row</p>
<p>定义删除方法</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> remove(row) &#123;</span><br><span class="line"><span class="comment">//element的提示框组件</span></span><br><span class="line">  <span class="keyword">this</span>.$confirm(</span><br><span class="line">    <span class="string">`此操作将永久删除<span class="subst">$&#123;row.name&#125;</span>这个分类的数据, 是否继续?`</span>,</span><br><span class="line">    <span class="string">"注意"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      confirmButtonText: <span class="string">"确定"</span>,</span><br><span class="line">      cancelButtonText: <span class="string">"取消"</span>,</span><br><span class="line">      type: <span class="string">"warning"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ).then(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.axios.delete(<span class="string">`categories/<span class="subst">$&#123;row._id&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">this</span>.fetch();</span><br><span class="line">    <span class="keyword">this</span>.$message(&#123;</span><br><span class="line">      type: <span class="string">"success"</span>,</span><br><span class="line">      message: <span class="string">"删除成功!"</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>去后端写删除的接口</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//删除接口</span></span><br><span class="line">router.delete(<span class="string">"/categories/:id"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> model = <span class="keyword">await</span> Category.findByIdAndDelete(req.params.id)<span class="comment">//通过id找之后更新,参数是要删除的id</span></span><br><span class="line">    res.send(&#123;</span><br><span class="line">        success: <span class="literal">true</span></span><br><span class="line">    &#125;)<span class="comment">//发送到客户端</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="上级分类"><a href="#上级分类" class="headerlink" title="上级分类"></a>上级分类</h3><p> 现在，需要加一个上级分类，用来保存所有分类的对应关系<br> <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">el-form-item</span> <span class="attr">label</span>=<span class="string">"上级分类"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-select</span> <span class="attr">v-model</span>=<span class="string">"model.parent"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-option</span> <span class="attr">v-for</span>=<span class="string">"item in parents"</span> <span class="attr">:key</span>=<span class="string">"item._id"</span> <span class="attr">:label</span>=<span class="string">"item.name"</span> <span class="attr">:value</span>=<span class="string">"item._id"</span>&gt;</span><span class="tag">&lt;/<span class="name">el-option</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>   后端需要在模型里添加字段<br> <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">const</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    <span class="comment">//上级分类</span></span><br><span class="line">    parent:&#123;</span><br><span class="line">        type:mongoose.SchemaTypes.ObjectId,<span class="comment">//因为保存的是其他集合的id，所以要这么写</span></span><br><span class="line">        ref:<span class="string">'Category'</span><span class="comment">//这里是关联哪个模型</span></span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//开始定义需要的字段 name是key ,type是类型</span></span><br><span class="line">    name:&#123;</span><br><span class="line">        type:<span class="built_in">String</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p> 这时在列表页就可以拿到上级分类的id了</p>
<p><img src="/images/pasted-47.png" alt="upload successful"><br>但是，上级分类这里显示的是id，正常来说应该显示的是分类名字，这样更直观，所以需要改列表页的接口</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//列表接口</span></span><br><span class="line">router.get(<span class="string">"/categories"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> items = <span class="keyword">await</span> Category.find().populate(<span class="string">"parent"</span>).limit(<span class="number">10</span>)<span class="comment">//查找所有数据，限制10条   如果数据库中有关联字段，就可以用populate查出来,传进去什么字段，就会直接找对应字段id所属的集合的所有信息，而不仅仅是id了</span></span><br><span class="line">    res.send(items)<span class="comment">//发送到客户端</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/images/pasted-48.png" alt="upload successful"></p>
<h3 id="通用CRUD接口"><a href="#通用CRUD接口" class="headerlink" title="通用CRUD接口"></a>通用CRUD接口</h3><p>将app.use里的路由定义成动态路由<br><code>app.use(&quot;/admin/api/rest/:resource&quot;, router)</code></p>
<p><img src="/images/pasted-49.png" alt="upload successful"><br>之后可以将路由中的categories都删了<br>因为需要按照路由引入对应的模型所有这个就不能要了<br><code>const Category = require(&quot;../../models/Category&quot;)//引入模型</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> router = express.Router(&#123;</span><br><span class="line">    mergeParams:<span class="literal">true</span><span class="comment">//上面添加这句，表示合并参数，因为内部要用</span></span><br><span class="line">&#125;)<span class="comment">//用到了子路由</span></span><br></pre></td></tr></table></figure>
<p> 之后console一下就可以拿到动态路由的名了</p>
<p><img src="/images/pasted-50.png" alt="upload successful"></p>
<p><img src="/images/pasted-51.png" alt="upload successful"></p>
<p>但是现在名字是小写复数，模型名是大写单数<br>就需要用inflection包来进行单复数转换<br><code>npm i inflection --save</code><br>列表页接口为例</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">router.get(<span class="string">"/"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> ModelName = <span class="built_in">require</span>(<span class="string">"inflection"</span>).classify(req.params.resource)<span class="comment">//转类名大小写，单复数</span></span><br><span class="line">      <span class="keyword">const</span> Model = <span class="built_in">require</span>(<span class="string">`../../models/<span class="subst">$&#123;ModelName&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">const</span> items = <span class="keyword">await</span> Model.find().populate(<span class="string">"parent"</span>).limit(<span class="number">10</span>)<span class="comment">//查找所有数据，限制10条   如果数据库中有关联字段，就可以用populate查出来,传进去什么字段，就会直接找对应字段id所属的集合的所有信息，而不仅仅是id了</span></span><br><span class="line">      res.send(items)<span class="comment">//发送到客户端</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>由于重复的地方太多，可以把引入模型和大小写转换放到一个中间件里执行</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.use(<span class="string">"/admin/api/rest/:resource"</span>,</span><br><span class="line">    <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> ModelName = <span class="built_in">require</span>(<span class="string">"inflection"</span>).classify(req.params.resource)<span class="comment">//转类名大小写，单复数</span></span><br><span class="line">        <span class="comment">// const Model = require(`../../models/$&#123;ModelName&#125;`)</span></span><br><span class="line">        <span class="comment">//由于这样后面的中间件是拿不到这个Model的，所以要把他添加到req中</span></span><br><span class="line">        req.Model = <span class="built_in">require</span>(<span class="string">`../../models/<span class="subst">$&#123;ModelName&#125;</span>`</span>)</span><br><span class="line">        next()</span><br><span class="line">    &#125;, router)</span><br></pre></td></tr></table></figure>
<p> 就可以将路由中的categories全删了，Category模型全换成req.model</p>
<p><img src="/images/pasted-52.png" alt="upload successful"><br>这时注意这里</p>
<p><img src="/images/pasted-53.png" alt="upload successful"><br>这个查找分类的上级，但是现在是通用的接口，现在这么做就不合适了，需要改成条件选择</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//列表接口</span></span><br><span class="line">    router.get(<span class="string">"/"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> queryOptions = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span>(req.Model.modelName === <span class="string">"Category"</span>)&#123;</span><br><span class="line">            queryOptions.populate = <span class="string">"parent"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果数据库中有关联字段，就可以用populate查出来,传进去什么字段，就会直接找对应字段id所属的集合的所有信息，而不仅仅是id了</span></span><br><span class="line">        <span class="keyword">const</span> items = <span class="keyword">await</span> req.Model.find().setOptions(queryOptions).limit(<span class="number">10</span>)<span class="comment">//查找所有数据，限制10条   </span></span><br><span class="line">        res.send(items)<span class="comment">//发送到客户端</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>


<h3 id="图片上传"><a href="#图片上传" class="headerlink" title="图片上传"></a>图片上传</h3><p>前端用element的upload定义个上传图像组件</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-form-item</span> <span class="attr">label</span>=<span class="string">"缩略图"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">         action里是上传的地址</span></span><br><span class="line"><span class="comment">         :on-success 是成功后做什么</span></span><br><span class="line"><span class="comment">         :before-upload 是上传前做什么</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-upload</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">"avatar-uploader"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:action</span>=<span class="string">"axios.defaults.baseURL + '/upload'"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:show-file-list</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:on-success</span>=<span class="string">"afterUpload"</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 判断有没有图片，有就展示图片没有就展示icon --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">v-if</span>=<span class="string">"model.smallImg"</span> <span class="attr">:src</span>=<span class="string">"model.smallImg"</span> <span class="attr">class</span>=<span class="string">"avatar"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">"el-icon-plus avatar-uploader-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-upload</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//先打印看看</span></span><br><span class="line">   afterUpload(res) &#123;</span><br><span class="line">       <span class="built_in">console</span>.log(res)</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>
<p>这时会报后端找不到的错误<br>这时去后端定义接口地址<br>这里需要一个处理图片的中间件，可以用multer<br><code>npm i multer</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 图片上传</span></span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">"multer"</span>)<span class="comment">//引入multer</span></span><br><span class="line"><span class="comment">//上传的中间件 dest 是目标地址</span></span><br><span class="line"><span class="keyword">const</span> upload = multer(</span><br><span class="line">    &#123;<span class="attr">dest</span>:__dirname+<span class="string">"/../../uploads"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="comment">//upload.single("file") 单个文件上传用single,参数是form data里的名字file</span></span><br><span class="line">app.post(<span class="string">"/admin/api/upload"</span>,upload.single(<span class="string">"file"</span>) ,<span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> file = req.file</span><br><span class="line">    file.url = <span class="string">`http://localhost:3000/uploads/<span class="subst">$&#123;file.filename&#125;</span>`</span><span class="comment">//添加http的地址</span></span><br><span class="line">    res.send(file)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>现在uploads里就已经有图片了，<br>这时需要去根index里加个静态文件的托管</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.use(<span class="string">"/uploads"</span>,express.static(__dirname+<span class="string">"/uploads"</span>))</span><br></pre></td></tr></table></figure>
<p>去前端补全afterUpload方法</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">afterUpload(res) &#123;</span><br><span class="line">    <span class="keyword">this</span>.$<span class="keyword">set</span>(this.model,'smallImg',res.url)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p> element在列表中展示图片<br> <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-table-column</span> <span class="attr">label</span>=<span class="string">"产品名称"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">slot-scope</span>=<span class="string">"scope"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">"scope.row.smallImg"</span> <span class="attr">style</span>=<span class="string">"height:3rem"</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-table-column</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="富文本"><a href="#富文本" class="headerlink" title="富文本"></a>富文本</h3><p>可以用  Vue2Editor<br><a href="https://www.npmjs.com/package/vue2-editor" target="_blank" rel="noopener">https://www.npmjs.com/package/vue2-editor</a></p>
<p>先下载<br><code>npm install vue2-editor</code></p>
<p>在script中引进来<br><code>import { VueEditor } from &quot;vue2-editor&quot;;</code></p>
<p><img src="/images/pasted-54.png" alt="upload successful"></p>
<p>注册组件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">components: &#123;</span><br><span class="line">  VueEditor</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><img src="/images/pasted-55.png" alt="upload successful"></p>
<p>去html中使用</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-form-item</span> <span class="attr">label</span>=<span class="string">"介绍"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vue-editor</span> <span class="attr">v-model</span>=<span class="string">"model.text"</span>&gt;</span><span class="tag">&lt;/<span class="name">vue-editor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>后端模型中定义个String接收就行了</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 介绍</span></span><br><span class="line">text:&#123;</span><br><span class="line">    type:<span class="built_in">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这样就已经可以用了<br> 但是现在有个问题，就是图片存储方式</p>
<p><img src="/images/pasted-56.png" alt="upload successful"><br>默认行为是直接把图片进行base64编码了，好处就是方便，坏处就是会造成这个接口体积过大，所以要改成之前上传图片的方式</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-form-item</span> <span class="attr">label</span>=<span class="string">"介绍"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- useCustomImageHandler使用自定义图片处理事件  image-added是图片上传后做什么事 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vue-editor</span> <span class="attr">useCustomImageHandler</span> @<span class="attr">image-added</span>=<span class="string">"handleImageAdded"</span> <span class="attr">v-model</span>=<span class="string">"model.text"</span>&gt;</span><span class="tag">&lt;/<span class="name">vue-editor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//富文本图片上传</span></span><br><span class="line"><span class="keyword">async</span> handleImageAdded(file, Editor, cursorLocation, resetUploader) &#123;</span><br><span class="line">  <span class="keyword">const</span> formData = <span class="keyword">new</span> FormData(); <span class="comment">//html自带的方法，用于提交表单数据</span></span><br><span class="line">  formData.append(<span class="string">"file"</span>, file); <span class="comment">//字段名是file</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.axios.post(<span class="string">"upload"</span>, formData);</span><br><span class="line">  Editor.insertEmbed(cursorLocation, <span class="string">"image"</span>, res.data.url);<span class="comment">//三个参数，第一个是光标位置，第二个是告诉插入一张图片，第三个是图片地址</span></span><br><span class="line">  resetUploader();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p> 现在图片就是个网络地址了</p>
<h3 id="登录权限问题"><a href="#登录权限问题" class="headerlink" title="登录权限问题"></a>登录权限问题</h3><p> 密码不应该明文保存，应该存储的是加密过的数据<br> 所以要把密码加工一下<br> 改密码的模型加个set处理方法</p>
<p> set里要进行散列密码，需要用个模块bcrypt来散列密码<br> <code>npm i bcryptjs</code>(bcrypt可以但是上传到服务器时会出问题，用bcryptjs就可以解决)<br>  <figure class="highlight js"><table><tr><td class="code"><pre><span class="line">password:&#123;</span><br><span class="line">    type:<span class="built_in">String</span>,</span><br><span class="line">    select:<span class="literal">false</span>,<span class="comment">//查询时这个字段不会被查出来,防止二次报错时对散列过的密码进行二次散列</span></span><br><span class="line">    <span class="keyword">set</span>(value)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">"bcryptjs"</span>).hashSync(value,<span class="number">10</span>)<span class="comment">//散列的方法,两个参数第一个是要散列的密码，第二个是加密指数，越大越安全，但是越耗时一般10-12就可以了</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br> 现在保存后密码就被散列了</p>
<p><img src="/images/pasted-57.png" alt="upload successful"></p>
<p>之后写个登录页，能提交用户名密码就行</p>
<p>之后去后端定义一个验证登录的接口</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//登录验证</span></span><br><span class="line">app.post(<span class="string">"/admin/api/login"</span>,<span class="keyword">async</span> (req,res)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;name,password&#125; = req.body</span><br><span class="line">    <span class="comment">// 根据用户名找用户 </span></span><br><span class="line">    <span class="keyword">const</span> Admin = <span class="built_in">require</span>(<span class="string">"../../models/Admin"</span>)</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> Admin.findOne(&#123;name&#125;)</span><br><span class="line">    <span class="keyword">if</span>(!user)&#123;</span><br><span class="line">        <span class="comment">// 如果没有</span></span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">422</span>).send(&#123;</span><br><span class="line">            message:<span class="string">"用户不存在"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 校验密码</span></span><br><span class="line">    <span class="comment">// 返回token</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p> 这里先写一半，这里用户如果不存在就会返回一个错误码,前端需要根据这个错误码在页面上做出提示</p>
<p>去axios里加个拦截器</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">"axios"</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span></span><br><span class="line"><span class="keyword">const</span> http = axios.create(&#123;</span><br><span class="line">    baseURL: <span class="string">"http://localhost:3000/admin/api"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//后拦截器</span></span><br><span class="line">http.interceptors.response.use(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res <span class="comment">//没问题就直接return</span></span><br><span class="line">&#125;, err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.response.data.message) &#123;</span><br><span class="line">        <span class="comment">//console.log(err.response.data.message)报错的响应数据</span></span><br><span class="line">        Vue.prototype.$message.error(err.response.data.message)<span class="comment">//现在vue实例上有element，可以直接用$message这个弹出框</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err)<span class="comment">//有问题就返回报错</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> http</span><br></pre></td></tr></table></figure>
<p>现在前端捕获完错误了，可以回过头写后端验证登录的接口了</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//登录验证</span></span><br><span class="line">app.post(<span class="string">"/admin/api/login"</span>,<span class="keyword">async</span> (req,res)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;name,password&#125; = req.body</span><br><span class="line">    <span class="comment">// 根据用户名找用户 </span></span><br><span class="line">    <span class="keyword">const</span> Admin = <span class="built_in">require</span>(<span class="string">"../../models/Admin"</span>)</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> Admin.findOne(&#123;name&#125;).select(<span class="string">"+password"</span>)</span><br><span class="line">    <span class="comment">//因为之前模型中密码的select设成false里，默认是查不到的，所有加上select("+password")来强制获取密码，- 就是排除</span></span><br><span class="line">    <span class="keyword">if</span>(!user)&#123;</span><br><span class="line">        <span class="comment">// 如果没有</span></span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">422</span>).send(&#123;</span><br><span class="line">            message:<span class="string">"用户不存在"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 校验密码</span></span><br><span class="line">    <span class="keyword">const</span> isValid = <span class="built_in">require</span>(<span class="string">"bcryptjs"</span>).compareSync(password,user.password)<span class="comment">//用bcrypt的compareSync来验证密码，第一个参数是明文（提交上来的）,第二个是密文(数据库里存的)</span></span><br><span class="line">        <span class="keyword">if</span>(!isValid)&#123;</span><br><span class="line">        <span class="comment">//密码不对</span></span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">422</span>).send(&#123;</span><br><span class="line">            message:<span class="string">"密码错误"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回token</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p> 现在差返回个token，可以用jsonwebtoken插件来解决<br>   <code>npm i jsonwebtoken</code><br>   <figure class="highlight js"><table><tr><td class="code"><pre><span class="line">   <span class="comment">// 返回token</span></span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">"jsonwebtoken"</span>)</span><br><span class="line"><span class="keyword">const</span> token = jwt.sign(&#123;<span class="attr">id</span>: user._id&#125;,<span class="string">"sybsdz"</span>)<span class="comment">//用来生成token,第一个参数是个对象，里面的东西是想散列的东西,第二个参数是个秘钥(自己定义，随便写   )，之后会根据自己内部的算法来生成个token</span></span><br><span class="line">res.send(&#123;token&#125;)</span><br></pre></td></tr></table></figure><br>   现在前端就可以拿到token了,接着补全登录方法</p>
<p><img src="/images/pasted-58.png" alt="upload successful"></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> login() &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.model.name || !<span class="keyword">this</span>.model.password) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$message.error(<span class="string">"用户名或密码不能为空"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.axios.post(<span class="string">"login"</span>, <span class="keyword">this</span>.model);</span><br><span class="line">  localStorage.token = res.data.token; <span class="comment">//将token写入本地缓存中</span></span><br><span class="line">  <span class="keyword">this</span>.$router.push(<span class="string">"/"</span>);</span><br><span class="line">  <span class="keyword">this</span>.$message.success(<span class="string">"登录成功"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在前端有了token就得给所有请求之前加个请求头<br>axios里加个拦截器</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//前拦截器</span></span><br><span class="line">http.interceptors.request.use(<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//为所有的请求添加一个token 前面加Bearer是为了规范</span></span><br><span class="line">    config.headers.Authorization =<span class="string">"Bearer "</span> + localStorage.token</span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>后端改接口，处理token,列表页为例</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//列表接口</span></span><br><span class="line">router.get(<span class="string">"/"</span>, <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="built_in">String</span>(req.headers.authorization||<span class="string">''</span>).split(<span class="string">" "</span>).pop()<span class="comment">//这里前端定义的请求头是大写，后端要小写 pop提取最后一个元素</span></span><br><span class="line">    <span class="keyword">if</span>(!token)&#123;</span><br><span class="line">        <span class="comment">//没有token报错</span></span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">401</span>).send(&#123;</span><br><span class="line">            message: <span class="string">"请先登录"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123;id&#125; = jwt.verify(token,<span class="string">"sybsdz"</span>)<span class="comment">//verify是校验，第一个参数是token，第二个是自己定义的那个秘钥，注意这时jwt的引用已经提到最上面了,这个id就是用户的id</span></span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="comment">//解密不出来id</span></span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">401</span>).send(&#123;</span><br><span class="line">            message: <span class="string">"请先登录"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    req.user = <span class="keyword">await</span> Admin.findById(id)<span class="comment">//通过id去admin表里查，万一是假的呢，注意这里Admin的引入也提前到最开始了</span></span><br><span class="line">    <span class="keyword">if</span>(!req.user)&#123;</span><br><span class="line">        <span class="comment">//没有这个用户</span></span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">401</span>).send(&#123;</span><br><span class="line">            message: <span class="string">"请先登录"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(req.user)</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">&#125;, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> queryOptions = &#123;&#125;</span><br><span class="line">    <span class="comment">//如果数据库中有关联字段，就可以用populate查出来,传进去什么字段，就会直接找对应字段id所属的集合的所有信息，而不仅仅是id了</span></span><br><span class="line">    <span class="keyword">if</span> (req.Model.modelName === <span class="string">"Category"</span>) &#123;</span><br><span class="line">        queryOptions.populate = <span class="string">"parent"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// queryOptions.populate = "parent"</span></span><br><span class="line">    <span class="keyword">const</span> items = <span class="keyword">await</span> req.Model.find().setOptions(queryOptions)<span class="comment">//查找所有数据，限制10条   </span></span><br><span class="line">    res.send(items)<span class="comment">//发送到客户端</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p> 前端在axios拦截器中判断，状态码是401就跳到登录页<br> <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">"./router"</span><span class="comment">//先把路由引进来</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">//后拦截器</span></span><br><span class="line">http.interceptors.response.use(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res <span class="comment">//没问题就直接return</span></span><br><span class="line">&#125;, err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.response.data.message) &#123;</span><br><span class="line">        <span class="comment">//console.log(err.response.data.message)报错的响应数据</span></span><br><span class="line">        Vue.prototype.$message.error(err.response.data.message)<span class="comment">//现在vue实例上有element，可以直接用$message这个弹出框</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(err.response.status=== <span class="number">401</span> )&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">        router.push(<span class="string">"/login"</span>)<span class="comment">//跳到登录页</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err)<span class="comment">//有问题就返回报错</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>现在去后端把判断token的中间件变成个模块</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">   <span class="comment">//登录授权中间件</span></span><br><span class="line">   <span class="keyword">const</span> auth = <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">       <span class="keyword">const</span> token = <span class="built_in">String</span>(req.headers.authorization||<span class="string">''</span>).split(<span class="string">" "</span>).pop()<span class="comment">//这里前端定义的请求头是大写，后端要小写 pop提取最后一个元素</span></span><br><span class="line">       <span class="keyword">if</span>(!token)&#123;</span><br><span class="line">           <span class="comment">//没有token报错</span></span><br><span class="line">           <span class="keyword">return</span> res.status(<span class="number">401</span>).send(&#123;</span><br><span class="line">               message: <span class="string">"请先登录"</span></span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">const</span> &#123;id&#125; = jwt.verify(token,<span class="string">"sybsdz"</span>)<span class="comment">//verify是校验，第一个参数是token，第二个是自己定义的那个秘钥，注意这时jwt的引用已经提到最上面了,这个id就是用户的id</span></span><br><span class="line">       <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">           <span class="comment">//解密不出来id</span></span><br><span class="line">           <span class="keyword">return</span> res.status(<span class="number">401</span>).send(&#123;</span><br><span class="line">               message: <span class="string">"请先登录"</span></span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">       req.user = <span class="keyword">await</span> Admin.findById(id)<span class="comment">//通过id去admin表里查，万一是假的呢，注意这里Admin的引入也提前到最开始了</span></span><br><span class="line">       <span class="keyword">if</span>(!req.user)&#123;</span><br><span class="line">           <span class="comment">//没有这个用户</span></span><br><span class="line">           <span class="keyword">return</span> res.status(<span class="number">401</span>).send(&#123;</span><br><span class="line">               message: <span class="string">"请先登录"</span></span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">console</span>.log(req.user)</span><br><span class="line">       <span class="keyword">await</span> next()</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在需要的地方直接用auth</span></span><br><span class="line">   app.use(<span class="string">"/admin/api/rest/:resource"</span>,auth,</span><br><span class="line">       <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">           <span class="keyword">const</span> ModelName = <span class="built_in">require</span>(<span class="string">"inflection"</span>).classify(req.params.resource)<span class="comment">//转类名大小写，单复数</span></span><br><span class="line">           <span class="comment">// const Model = require(`../../models/$&#123;ModelName&#125;`)</span></span><br><span class="line">           <span class="comment">//由于这样后面的中间件是拿不到这个Model的，所以要把他添加到req中</span></span><br><span class="line">           req.Model = <span class="built_in">require</span>(<span class="string">`../../models/<span class="subst">$&#123;ModelName&#125;</span>`</span>)</span><br><span class="line">           next()</span><br><span class="line">       &#125;, router)</span><br></pre></td></tr></table></figure>
<p>  但是现在图片上传没有加上token<br>  去main.js定义一个全局的加header方法 一定要写在new Vue前面<br>  <figure class="highlight js"><table><tr><td class="code"><pre><span class="line">  Vue.mixin(&#123;</span><br><span class="line">    methods: &#123;</span><br><span class="line">        getAuthHeaders() &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                Authorization: <span class="string">"Bearer "</span> + (localStorage.token || <span class="string">''</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><br>之后在页面上直接用就行</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-upload</span></span></span><br><span class="line"><span class="tag">  <span class="attr">class</span>=<span class="string">"avatar-uploader"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:action</span>=<span class="string">"axios.defaults.baseURL + '/upload'"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:headers</span>=<span class="string">"getAuthHeaders()"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:show-file-list</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:on-success</span>=<span class="string">"afterUpload"</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="前端接口实例"><a href="#前端接口实例" class="headerlink" title="前端接口实例"></a>前端接口实例</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">"express"</span>).Router()</span><br><span class="line">    <span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">"mongoose"</span>)</span><br><span class="line">    <span class="comment">// const Article = require("../../models/Article")</span></span><br><span class="line">    <span class="keyword">const</span> Webindex = <span class="built_in">require</span>(<span class="string">"../../models/Webindex"</span>)</span><br><span class="line">    <span class="keyword">const</span> Webfooter = <span class="built_in">require</span>(<span class="string">"../../models/Webfooter"</span>)</span><br><span class="line">    <span class="keyword">const</span> Sound = <span class="built_in">require</span>(<span class="string">"../../models/Sound"</span>)</span><br><span class="line">    <span class="keyword">const</span> System = <span class="built_in">require</span>(<span class="string">"../../models/System"</span>)</span><br><span class="line">    <span class="keyword">const</span> Microphone = <span class="built_in">require</span>(<span class="string">"../../models/Microphone"</span>)</span><br><span class="line">    <span class="keyword">const</span> Other = <span class="built_in">require</span>(<span class="string">"../../models/Other"</span>)</span><br><span class="line">    <span class="keyword">const</span> Combination = <span class="built_in">require</span>(<span class="string">"../../models/Combination"</span>)</span><br><span class="line">    <span class="keyword">const</span> Amplifier = <span class="built_in">require</span>(<span class="string">"../../models/Amplifier"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> Category = <span class="built_in">require</span>(<span class="string">"../../models/Category"</span>)</span><br><span class="line">    <span class="comment">// footer接口</span></span><br><span class="line">    router.get(<span class="string">"/footer"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> model = <span class="keyword">await</span> Webfooter.find()</span><br><span class="line">        <span class="keyword">let</span> footerData = model[<span class="number">0</span>]</span><br><span class="line">        res.send(footerData)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 首页接口</span></span><br><span class="line">    router.get(<span class="string">"/index"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> model = <span class="keyword">await</span> Webindex.find()</span><br><span class="line">        <span class="keyword">let</span> indexData = model[<span class="number">0</span>]</span><br><span class="line">        res.send(indexData)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 产品接口</span></span><br><span class="line">    router.get(<span class="string">"/prodect/:index"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> index = req.params.index</span><br><span class="line">        <span class="keyword">let</span> model;</span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// &#123;&#125;,&#123;_id:1,smallImg:1,name:1,parent["name"]:1&#125;</span></span><br><span class="line">            model = <span class="keyword">await</span> System.find(&#123;&#125;, &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">smallImg</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">parent</span>: <span class="number">1</span> &#125;).populate(<span class="string">"parent"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">1</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> Amplifier.find(&#123;&#125;, &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">smallImg</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">parent</span>: <span class="number">1</span> &#125;).populate(<span class="string">"parent"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">2</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> Sound.find(&#123;&#125;, &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">smallImg</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">parent</span>: <span class="number">1</span> &#125;).populate(<span class="string">"parent"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">3</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> Microphone.find(&#123;&#125;, &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">smallImg</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">parent</span>: <span class="number">1</span> &#125;).populate(<span class="string">"parent"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">4</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> Other.find(&#123;&#125;, &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">smallImg</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">5</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> Combination.find(&#123;&#125;, &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">smallImg</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span> &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        res.send(model)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">//详情接口</span></span><br><span class="line">    router.get(<span class="string">"/:index/:id"</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> index = req.params.index</span><br><span class="line">        <span class="keyword">const</span> id = req.params.id</span><br><span class="line">        <span class="keyword">let</span> model;</span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> System.findById(id)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">1</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> Amplifier.findById(id)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">2</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> Sound.findById(id)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">3</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> Microphone.findById(id)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">4</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> Other.findById(id)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">5</span>) &#123;</span><br><span class="line">            model = <span class="keyword">await</span> Combination.findById(id).populate([<span class="string">"system"</span>,<span class="string">"amplifier"</span>,<span class="string">"sound"</span>,<span class="string">"microphone"</span>])</span><br><span class="line">        &#125;</span><br><span class="line">        res.send(model)</span><br><span class="line">    &#125;)</span><br><span class="line">    app.use(<span class="string">"/web/api"</span>, router)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">大白腿</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/07/09/node%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA%E6%B5%81%E7%A8%8B/">http://yoursite.com/2020/07/09/node%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA%E6%B5%81%E7%A8%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">大白腿</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/element/">element</a><a class="post-meta__tags" href="/tags/node/">node</a><a class="post-meta__tags" href="/tags/express/">express</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/07/20/vue%E6%95%B0%E6%8D%AE%E6%94%B9%E5%8F%98%E9%A1%B5%E9%9D%A2%E4%B8%8D%E6%9B%B4%E6%96%B0/"><img class="prev_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">vue数据改变页面不更新</div></div></a></div><div class="next-post pull_right"><a href="/2020/07/09/vue2-x%E5%8D%87%E7%BA%A7%E6%88%90vue3/"><img class="next_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">vue2.x升级成vue3</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/05/24/express-generator的使用/" title="express-generator的使用"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-24</div><div class="relatedPosts_title">express-generator的使用</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/24/express允许跨域/" title="express允许跨域"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-24</div><div class="relatedPosts_title">express允许跨域</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/24/express连接mysql数据库/" title="express连接mysql数据库"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-24</div><div class="relatedPosts_title">express连接mysql数据库</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/24/element后台/" title="element后台"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-24</div><div class="relatedPosts_title">element后台</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/24/element安装/" title="element安装"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-24</div><div class="relatedPosts_title">element安装</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/24/el-table/" title="el-table"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-24</div><div class="relatedPosts_title">el-table</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2020 By 大白腿</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script></body></html>